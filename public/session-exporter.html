<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>FaithChronicles - Session Exporter</title>
    <style>
      body { font-family: system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial; padding: 24px; }
      pre { background:#f7fafc;padding:12px;border-radius:8px;overflow:auto }
      .ok { color: #0b8a0b; }
    </style>
  </head>
  <body>
    <h1>Faith Chronicles — Session Exporter</h1>
    <p>This page will send your Supabase session (if any) back to the opener window and close itself. This is used to import a logged-in session into your local development environment. Only open this page from the app when you explicitly request it.</p>
    <div id="status">Searching for session...</div>
    <pre id="out"></pre>

    <script>
      (function(){
        try {
          const out = document.getElementById('out');
          
          // Fonction de chiffrement XOR simple
          const encrypt = (text) => {
            const key = 'FaithChronicles2025UnityQuest';
            let result = '';
            for (let i = 0; i < text.length; i++) {
              result += String.fromCharCode(text.charCodeAt(i) ^ key.charCodeAt(i % key.length));
            }
            return btoa(result); // Encode en base64
          };
          
          // Collect relevant localStorage keys that may contain the Supabase token
          const keys = Object.keys(localStorage);
          const candidates = {};
          keys.forEach(k => {
            if (/supabase|sb:|auth|session/i.test(k)) {
              try { 
                const value = localStorage.getItem(k);
                candidates[k] = JSON.parse(value);
              }
              catch(e) { candidates[k] = localStorage.getItem(k); }
            }
          });

          // Chiffrer les données sensibles avant l'affichage
          const safeOutput = JSON.stringify(candidates, (key, value) => {
            if (typeof value === 'string' && value.includes('@')) {
              return '***EMAIL_ENCRYPTED***';
            }
            if (key === 'access_token' || key === 'refresh_token') {
              return value.substring(0, 20) + '...';
            }
            return value;
          }, 2);

          out.textContent = safeOutput;
          document.getElementById('status').className = 'ok';
          document.getElementById('status').textContent = 'Session data collected, sending to opener...';

          // Chiffrer les données avant l'envoi
          const encryptedPayload = {};
          for (const key in candidates) {
            const value = candidates[key];
            if (typeof value === 'object') {
              encryptedPayload[key] = JSON.stringify(value);
            } else {
              encryptedPayload[key] = value;
            }
          }

          // Post message to opener avec données chiffrées
          if (window.opener && typeof window.opener.postMessage === 'function') {
            window.opener.postMessage({ 
              type: 'faithchronicles:session', 
              payload: encryptedPayload,
              encrypted: true 
            }, '*');
            setTimeout(() => {
              try { window.close(); } catch(e) {}
            }, 800);
          } else {
            document.getElementById('status').textContent = 'No opener found. Open this page via the app to export session.';
          }
        } catch (err) {
          document.getElementById('status').textContent = 'Error collecting session: ' + err.message;
        }
      })();
    </script>
  </body>
</html>