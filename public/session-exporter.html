<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>FaithChronicles - Session Exporter</title>
    <style>
      body { font-family: system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial; padding: 24px; }
      pre { background:#f7fafc;padding:12px;border-radius:8px;overflow:auto }
      .ok { color: #0b8a0b; }
    </style>
  </head>
  <body>
    <h1>Faith Chronicles â€” Session Exporter</h1>
    <p>This page will send your Supabase session (if any) back to the opener window and close itself. This is used to import a logged-in session into your local development environment. Only open this page from the app when you explicitly request it.</p>
    <div id="status">Searching for session...</div>
    <pre id="out"></pre>

    <script>
      (function(){
        try {
          const out = document.getElementById('out');
          // Collect relevant localStorage keys that may contain the Supabase token
          const keys = Object.keys(localStorage);
          const candidates = {};
          keys.forEach(k => {
            if (/supabase|sb:|auth|session/i.test(k)) {
              try { candidates[k] = JSON.parse(localStorage.getItem(k)); }
              catch(e) { candidates[k] = localStorage.getItem(k); }
            }
          });

          out.textContent = JSON.stringify(candidates, null, 2);
          document.getElementById('status').className = 'ok';
          document.getElementById('status').textContent = 'Session data collected, sending to opener...';

          // Post message to opener
          if (window.opener && typeof window.opener.postMessage === 'function') {
            window.opener.postMessage({ type: 'faithchronicles:session', payload: candidates }, '*');
            setTimeout(() => {
              try { window.close(); } catch(e) {}
            }, 800);
          } else {
            document.getElementById('status').textContent = 'No opener found. Open this page via the app to export session.';
          }
        } catch (err) {
          document.getElementById('status').textContent = 'Error collecting session: ' + err.message;
        }
      })();
    </script>
  </body>
</html>